name: Build rgeo gem for Windows

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        ruby-version: ['2.4',]
    
    steps:
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}
      
      - name: Install build tools
        run: choco install mingw -y
      
      - name: Install GEOS
        run: choco install geos -y
      
      - name: Build rgeo gem with verbose output
        run: |
          gem install rgeo --version 2.2 -v --platform=x64-mingw-ucrt 2>&1
        continue-on-error: true
      
      - name: Find and package compiled gem
        run: |
          $gemPath = ruby -r rubygems -e "puts Gem.default_dir"
          echo "Gem Path: $gemPath"
          
          # Create output directory
          $outputDir = "rgeo-compiled-ruby-${{ matrix.ruby-version }}"
          New-Item -ItemType Directory -Path $outputDir -Force
          
          # Copy the entire rgeo gem folder
          if (Test-Path "$gemPath\gems\rgeo*") {
            Copy-Item "$gemPath\gems\rgeo*" "$outputDir\gems\" -Recurse -Force
            echo "Copied gems"
          }
          
          # Copy compiled extensions
          if (Test-Path "$gemPath\extensions") {
            Copy-Item "$gemPath\extensions\*\*\rgeo*" "$outputDir\extensions\" -Recurse -Force -ErrorAction SilentlyContinue
            echo "Copied extensions"
          }
          
          # List what we got
          echo "Contents:"
          Get-ChildItem $outputDir -Recurse
          
          # Create a zip file
          Compress-Archive -Path $outputDir -DestinationPath "rgeo-${{ matrix.ruby-version }}.zip" -Force
          echo "Created zip file"
      
      - name: Upload compiled gem
        uses: actions/upload-artifact@v4
        with:
          name: rgeo-compiled-ruby-${{ matrix.ruby-version }}
          path: rgeo-${{ matrix.ruby-version }}.zip
          retention-days: 30
